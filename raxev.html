<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>RAX Predictions EV & Kelly Calc</title>
  <style>
    body{font-family:sans-serif;margin:20px;background:#000;color:#ccc;text-align:center}
    input,button,select{margin:5px;padding:15px;font-size:16px;border-radius:25px;border:2px solid #ccc;transition:.3s}
    input,select{background:#333;color:#ccc;border:2px solid #555}
    input:focus,button:focus,select:focus{border-color:#07f;outline:0}
    button{cursor:pointer;background:#6f42c1;color:#fff;border:0}
    button:hover{background:#5a32a3}
    #clearButton{background:red;margin-left:10px}
    a{color:#858bf0}
    .highest-ev{color:#4CAF50;font-weight:bold}
    .history-section{margin:30px auto 0;max-width:800px;text-align:left}
    .history-item{background:#222;border:1px solid #444;border-radius:10px;padding:15px;margin:10px 0;position:relative}
    .history-timestamp{color:#888;font-size:12px;margin-bottom:10px}
    .copy-button{position:absolute;top:10px;right:10px;padding:5px 10px;font-size:12px;background:#28a745;border-radius:15px}
    .copy-button:hover{background:#218838}
    .history-content{font-family:monospace;font-size:14px;line-height:1.4}
    .clear-history-btn{background:#dc3545;margin-top:10px}
    .clear-history-btn:hover{background:#c82333}
    #historySection{display:none}
    .rax-label{color:#ff6b35;font-weight:bold}
    .input-section{margin:10px 0}
    .team2-inputs{display:block}
    .kelly-inputs{display:none}
    .payout-inputs{display:block}
    .slider-container{margin:15px auto;max-width:400px}
    .slider-container input[type="range"]{width:100%;padding:0;height:8px;background:#555;border-radius:5px;outline:none}
    .slider-container input[type="range"]::-webkit-slider-thumb{appearance:none;width:20px;height:20px;background:#6f42c1;cursor:pointer;border-radius:50%}
    .slider-container input[type="range"]::-moz-range-thumb{width:20px;height:20px;background:#6f42c1;cursor:pointer;border-radius:50%;border:none}
    .slider-labels{display:flex;justify-content:space-between;font-size:12px;color:#888;margin-top:5px}
  </style>
</head>
<body>
  <h1>RAX Predictions EV & Kelly Calc</h1>
  <p class="rax-label">Calculate Expected Value & Optimal Wager</p>
  
  <label><input type="checkbox" id="toggleOutput">Show All Outputs</label><br>
  <label><input type="checkbox" id="toggleHistory">Show History</label><br>
  <label><input type="checkbox" id="oneSideOnly">One Side Only</label><br>
  <label><input type="checkbox" id="calculateWager">Calculate Wager Amount (Kelly Criterion)</label><br>
  
  <div class="input-section">
    <input type="text" id="sportsbookOddsInput1" placeholder="Enter Team 1 American Odds (e.g., +150)"><br>
    <input type="text" id="sportsbookOddsInput2" placeholder="Enter Team 2 American Odds (e.g., -120)"><br>
    
    <span class="payout-inputs">
      <input type="number" id="payoutInput1" placeholder="Enter Team 1 Payout (RAX)" min="0" step="1"><br>
      <span class="team2-inputs">
        <input type="number" id="payoutInput2" placeholder="Enter Team 2 Payout (RAX)" min="0" step="1"><br>
      </span>
    </span>
    
    <span class="kelly-inputs">
      <input type="number" id="communityPercent1" placeholder="Community % on Team 1" min="0" max="100" step="0.1" style="width:217px"><br>
      <span class="team2-inputs">
        <input type="number" id="communityPercent2" placeholder="Community % on Team 2" min="0" max="100" step="0.1" style="width:217px"><br>
      </span>
    </span>
  </div>
  
  <div class="input-section">
    <input type="number" id="stakeInput" placeholder="Enter Stake/Max Amount (RAX)" min="1" step="1"><br>
  </div>
  
  <div class="slider-container kelly-inputs">
    <label for="kellySlider"><strong>Risk Level:</strong> <span id="kellyValue">50%</span> of Kelly</label><br>
    <input type="range" id="kellySlider" min="10" max="100" value="50" step="5">
    <div class="slider-labels">
      <span>Conservative (10%)</span>
      <span>Moderate (50%)</span>
      <span>Aggressive (100%)</span>
    </div>
  </div>
  
  <button onclick="calculateEV()">Calculate</button>
  <button id="clearButton" onclick="clearInputs()">Clear</button><br><br>
  
  <p id="result"></p>
  
  <div id="historySection" class="history-section">
    <h2>Calculation History</h2>
    <button class="clear-history-btn" onclick="clearHistory()">Clear History</button>
    <div id="historyContainer"></div>
  </div>
  
  <button onclick="window.location.href='index.html'">Go Home</button><br><br>
  <p>designed by @tomfc on Real</p>
  
  <script>
    const $ = id => document.getElementById(id),
      round = Math.round,
      to2 = v => round(v*100)/100,
      to4 = v => round(v*10000)/10000,
      parseOdds = i => {
        const v = parseInt($(i).value);
        return v && v !== 0 ? v : null;
      },
      imP = o => o > 0 ? 100/(100+o) : Math.abs(o)/(Math.abs(o)+100),
      fracP = o => `${round(o>0?100:Math.abs(o))}/${round(o>0?100+o:100-o)}`,
      amToDec = a => a>0 ? a/100+1 : 100/Math.abs(a)+1;

    function getNameLabels() {
      return ["Team 1", "Team 2"];
    }

    function toggleHistorySection() {
      const show = $('toggleHistory').checked;
      $('historySection').style.display = show ? 'block' : 'none';
      if (show) updateHistoryDisplay();
    }

    function saveToHistory(calc) {
      let h = getHistory();
      h.unshift({...calc, timestamp: new Date().toLocaleString()});
      if (h.length > 50) h = h.slice(0, 50);
      try {
        localStorage.setItem('raxEvCalcHistory', JSON.stringify(h));
      } catch(e) {
        console.error('Storage failed:', e);
      }
      updateHistoryDisplay();
    }

    function getHistory() {
      try {
        return JSON.parse(localStorage.getItem('raxEvCalcHistory') || '[]');
      } catch(e) {
        return [];
      }
    }

    function clearHistory() {
      localStorage.removeItem('raxEvCalcHistory');
      updateHistoryDisplay();
    }

    function updateHistoryDisplay() {
      const h = getHistory();
      const c = $('historyContainer');
      if (!h.length) {
        c.innerHTML = '<p>No calculations yet.</p>';
        return;
      }
      c.innerHTML = h.map((calc, i) => `
        <div class="history-item">
          <button class="copy-button" onclick="copyToClipboard(${i})">Copy</button>
          <div class="history-timestamp">${calc.timestamp}</div>
          <div class="history-content">${formatCalculationForDisplay(calc)}</div>
        </div>
      `).join('');
    }

    function formatCalculationForDisplay(c) {
      const label1 = c.label1 || "Side 1";
      const label2 = c.label2 || "Side 2";
      
      let lines = [
        c.isKelly ? `RAX Kelly Criterion Calculation` : `RAX Manual Payout Calculation`,
        `Sportsbook Odds: ${c.sportsbookOdds1} vs ${c.sportsbookOdds2}`,
        c.isKelly ? `Max Wager: ${c.stake} RAX` : `Stake: ${c.stake} RAX`,
        ``,
        `No-Vig Probabilities:`,
        `&nbsp;&nbsp;${label1}: ${c.noVigProb1} (${c.fractionalProb1})`,
        `&nbsp;&nbsp;${label2}: ${c.noVigProb2} (${c.fractionalProb2})`,
        ``
      ];
      
      if (c.isKelly) {
        lines.push(`Community Distribution:`);
        if (c.communityPercent1) lines.push(`&nbsp;&nbsp;${label1}: ${c.communityPercent1}%`);
        if (c.communityPercent2) lines.push(`&nbsp;&nbsp;${label2}: ${c.communityPercent2}%`);
        lines.push(``);
        lines.push(`Kelly Criterion (${c.kellyPercent}% of full Kelly):`);
        if (c.kelly1 !== null) lines.push(`&nbsp;&nbsp;${label1}: Bet ${c.kelly1} RAX (EV: ${c.ev1} RAX)${c.kelly1 === c.maxKelly ? ' ✅ BEST' : ''}`);
        if (c.kelly2 !== null) lines.push(`&nbsp;&nbsp;${label2}: Bet ${c.kelly2} RAX (EV: ${c.ev2} RAX)${c.kelly2 === c.maxKelly ? ' ✅ BEST' : ''}`);
      } else {
        if (c.payout1 !== null || c.payout2 !== null) {
          lines.push(`Payouts:`);
          if (c.payout1 !== null) lines.push(`&nbsp;&nbsp;${label1}: ${c.payout1} RAX`);
          if (c.payout2 !== null) lines.push(`&nbsp;&nbsp;${label2}: ${c.payout2} RAX`);
          lines.push(``);
        }
        
        lines.push(`Expected Values:`);
        if (c.ev1 !== null) lines.push(`&nbsp;&nbsp;${label1}: ${c.ev1} RAX${c.ev1 === c.maxEV ? ' ✅ BEST' : ''}`);
        if (c.ev2 !== null) lines.push(`&nbsp;&nbsp;${label2}: ${c.ev2} RAX${c.ev2 === c.maxEV ? ' ✅ BEST' : ''}`);
      }
      
      return lines.join('<br>');
    }

    function formatCalculationForHistory(c) {
      const label1 = c.label1 || "Side 1";
      const label2 = c.label2 || "Side 2";
      
      let lines = [
        c.isKelly ? `RAX Kelly Criterion Calculation` : `RAX Manual Payout Calculation`,
        `Sportsbook Odds: ${c.sportsbookOdds1} vs ${c.sportsbookOdds2}`,
        c.isKelly ? `Max Wager: ${c.stake} RAX` : `Stake: ${c.stake} RAX`,
        ``,
        `No-Vig Probabilities:`,
        `  ${label1}: ${c.noVigProb1} (${c.fractionalProb1})`,
        `  ${label2}: ${c.noVigProb2} (${c.fractionalProb2})`,
        ``
      ];
      
      if (c.isKelly) {
        lines.push(`Community Distribution:`);
        if (c.communityPercent1) lines.push(`  ${label1}: ${c.communityPercent1}%`);
        if (c.communityPercent2) lines.push(`  ${label2}: ${c.communityPercent2}%`);
        lines.push(``);
        lines.push(`Kelly Criterion (${c.kellyPercent}% of full Kelly):`);
        if (c.kelly1 !== null) lines.push(`  ${label1}: Bet ${c.kelly1} RAX (EV: ${c.ev1} RAX)${c.kelly1 === c.maxKelly ? ' ✅ BEST' : ''}`);
        if (c.kelly2 !== null) lines.push(`  ${label2}: Bet ${c.kelly2} RAX (EV: ${c.ev2} RAX)${c.kelly2 === c.maxKelly ? ' ✅ BEST' : ''}`);
      } else {
        if (c.payout1 !== null || c.payout2 !== null) {
          lines.push(`Payouts:`);
          if (c.payout1 !== null) lines.push(`  ${label1}: ${c.payout1} RAX`);
          if (c.payout2 !== null) lines.push(`  ${label2}: ${c.payout2} RAX`);
          lines.push(``);
        }
        
        lines.push(`Expected Values:`);
        if (c.ev1 !== null) lines.push(`  ${label1}: ${c.ev1} RAX${c.ev1 === c.maxEV ? ' ✅ BEST' : ''}`);
        if (c.ev2 !== null) lines.push(`  ${label2}: ${c.ev2} RAX${c.ev2 === c.maxEV ? ' ✅ BEST' : ''}`);
      }
      
      return lines.join('\n');
    }

    function copyToClipboard(i) {
      const h = getHistory();
      const c = h[i];
      const txt = formatCalculationForHistory(c);
      const btn = event.target;
      const old = btn.textContent;
      
      navigator.clipboard.writeText(txt).then(() => {
        btn.textContent = 'Copied!';
        btn.style.background = '#28a745';
        setTimeout(() => {
          btn.textContent = old;
          btn.style.background = '';
        }, 1000);
      }).catch(() => {
        const t = document.createElement('textarea');
        t.value = txt;
        document.body.appendChild(t);
        t.select();
        document.execCommand('copy');
        document.body.removeChild(t);
        btn.textContent = 'Copied!';
        setTimeout(() => {
          btn.textContent = old;
        }, 1000);
      });
    }

    function calculateEV() {
      const sbo1 = parseOdds('sportsbookOddsInput1');
      const sbo2 = parseOdds('sportsbookOddsInput2');
      const maxAmount = parseFloat($('stakeInput').value);
      const oneSideOnly = $('oneSideOnly').checked;
      const isKelly = $('calculateWager').checked;
      
      if (sbo1 === null || sbo2 === null) {
        alert('Please enter valid American odds for both sides.');
        return;
      }
      
      if (isNaN(maxAmount) || maxAmount <= 0) {
        alert('Please enter a valid stake/max amount.');
        return;
      }
      
      const labels = getNameLabels();
      
      // Calculate no-vig probabilities from sportsbook odds
      const prob1 = imP(sbo1);
      const prob2 = imP(sbo2);
      const tot = prob1 + prob2;
      const nvP1 = prob1 / tot;
      const nvP2 = prob2 / tot;
      
      // Calculate no-vig American odds
      const nvO1 = nvP1 < 0.5 ? round(100 * (1 - nvP1) / nvP1) : -round(100 * nvP1 / (1 - nvP1));
      const nvO2 = nvP2 < 0.5 ? round(100 * (1 - nvP2) / nvP2) : -round(100 * nvP2 / (1 - nvP2));
      
      // Get fractional probabilities
      const fp1 = fracP(nvO1);
      const fp2 = fracP(nvO2);
      
      const showAll = $('toggleOutput').checked;
      let r = '';
      
      if (showAll) {
        r += `${labels[0]} No-Vig American Odds: ${nvO1} (Decimal: ${amToDec(nvO1).toFixed(2)})<br>
        ${labels[1]} No-Vig American Odds: ${nvO2} (Decimal: ${amToDec(nvO2).toFixed(2)})<br>
        ${labels[0]} No-Vig Probability: ${nvP1.toFixed(4)}<br>
        ${labels[1]} No-Vig Probability: ${nvP2.toFixed(4)}<br>
        ${labels[0]} Fractional Probability: ${fp1}<br>
        ${labels[1]} Fractional Probability: ${fp2}<br><br>`;
      }
      
      if (isKelly) {
        // Kelly Criterion Mode
        const comm1 = parseFloat($('communityPercent1').value);
        const comm2 = parseFloat($('communityPercent2').value);
        
        const hasComm1 = !isNaN(comm1) && comm1 >= 0;
        const hasComm2 = !isNaN(comm2) && comm2 >= 0;
        
        if (!hasComm1) {
          alert('Please enter community % for Team 1.');
          return;
        }
        
        if (!oneSideOnly && !hasComm2) {
          alert('Please enter community % for Team 2.');
          return;
        }
        
        // Validate percentages add up to ~100
        if (!oneSideOnly && hasComm1 && hasComm2) {
          const total = comm1 + comm2;
          if (Math.abs(total - 100) > 1) {
            alert(`Community percentages should add up to 100% (currently ${total.toFixed(1)}%)`);
            return;
          }
        }
        
        const kellyPercent = parseInt($('kellySlider').value);
        const kellyFraction = kellyPercent / 100;
        
        // Convert community percentages to fractions
        const c1 = comm1 / 100;
        const c2 = (!oneSideOnly && hasComm2) ? comm2 / 100 : null;
        
        // Kelly Criterion: f* = (p - c) / (1 - c)
        // p = your estimated probability of winning (no-vig probability)
        // c = fraction of community money on your side
        const kellyFull1 = (nvP1 - c1) / (1 - c1);
        const kellyFull2 = (!oneSideOnly && c2 !== null) ? (nvP2 - c2) / (1 - c2) : null;
        
        // Apply Kelly fraction (risk adjustment) and max amount
        const kelly1Raw = Math.max(0, kellyFull1 * kellyFraction * maxAmount);
        const kelly2Raw = (kellyFull2 !== null) ? Math.max(0, kellyFull2 * kellyFraction * maxAmount) : null;
        
        const kelly1 = to2(Math.min(kelly1Raw, maxAmount));
        const kelly2 = (kelly2Raw !== null) ? to2(Math.min(kelly2Raw, maxAmount)) : null;
        
        const maxKelly = Math.max(kelly1, kelly2 ?? -Infinity);
        
        // Calculate hypothetical payout based on community pool distribution
        // Total pool = sum of all bets, your share = (your bet / total on your side) * (total pool - your bet)
        // Simplified: if you bet on side with c fraction, you win (1/c - 1) * your_bet
        const hypotheticalPayout1 = kelly1 > 0 && c1 > 0 ? to2(kelly1 * (1/c1 - 1)) : 0;
        const hypotheticalPayout2 = (kelly2 !== null && kelly2 > 0 && c2 > 0) ? to2(kelly2 * (1/c2 - 1)) : null;
        
        // Calculate EV for Kelly bets
        const ev1Kelly = kelly1 > 0 ? to2(hypotheticalPayout1 * nvP1 - kelly1 * nvP2) : 0;
        const ev2Kelly = (kelly2 !== null && kelly2 > 0) ? to2(hypotheticalPayout2 * nvP2 - kelly2 * nvP1) : null;
        
        const calc = {
          isKelly: true,
          sportsbookOdds1: sbo1,
          sportsbookOdds2: sbo2,
          stake: maxAmount,
          noVigProb1: nvP1.toFixed(4),
          noVigProb2: nvP2.toFixed(4),
          fractionalProb1: fp1,
          fractionalProb2: fp2,
          communityPercent1: comm1,
          communityPercent2: (!oneSideOnly && hasComm2) ? comm2 : null,
          kellyPercent: kellyPercent,
          kelly1: kelly1,
          kelly2: kelly2,
          maxKelly: maxKelly,
          hypotheticalPayout1: hypotheticalPayout1,
          hypotheticalPayout2: hypotheticalPayout2,
          ev1: ev1Kelly,
          ev2: ev2Kelly,
          label1: labels[0],
          label2: labels[1]
        };
        
        saveToHistory(calc);
        
        r += `<strong>Kelly Criterion Results (${kellyPercent}% of full Kelly):</strong><br><br>`;
        r += `<strong>${labels[0]} Recommended Wager: ${kelly1} RAX${kelly1 === maxKelly ? ' ✅' : ''}</strong><br>`;
        r += `<strong>${labels[0]} Expected Value: ${ev1Kelly} RAX</strong><br>`;
        if (kelly2 !== null) {
          r += `<br><strong>${labels[1]} Recommended Wager: ${kelly2} RAX${kelly2 === maxKelly ? ' ✅' : ''}</strong><br>`;
          r += `<strong>${labels[1]} Expected Value: ${ev2Kelly} RAX</strong><br>`;
        }
        
        if (showAll) {
          r += `<br>Community on ${labels[0]}: ${comm1}%<br>`;
          if (c2 !== null) r += `Community on ${labels[1]}: ${comm2}%<br>`;
          r += `<br>Hypothetical payout ${labels[0]}: ${hypotheticalPayout1} RAX<br>`;
          if (hypotheticalPayout2 !== null) r += `Hypothetical payout ${labels[1]}: ${hypotheticalPayout2} RAX<br>`;
          r += `<br>Full Kelly fraction ${labels[0]}: ${to4(kellyFull1)}<br>`;
          if (kellyFull2 !== null) r += `Full Kelly fraction ${labels[1]}: ${to4(kellyFull2)}<br>`;
        }
        
        if (kelly1 === 0 && (kelly2 === null || kelly2 === 0)) {
          r += `<p style="color:#ff6b35"><strong>⚠️ No positive edge detected. Kelly recommends not betting.</strong></p>`;
        }
        
      } else {
        // Original EV Mode
        const payout1 = parseFloat($('payoutInput1').value);
        const payout2 = parseFloat($('payoutInput2').value);
        
        const hasPayout1 = !isNaN(payout1) && payout1 >= 0;
        const hasPayout2 = !isNaN(payout2) && payout2 >= 0;
        
        if (!hasPayout1) {
          alert('Please enter a payout amount for Team 1.');
          return;
        }
        
        if (!oneSideOnly && !hasPayout2) {
          alert('Please enter a payout amount for Team 2.');
          return;
        }
        
        // Calculate expected values: (payout * win_probability) - (stake * loss_probability)
        const ev1 = to2(payout1 * nvP1 - maxAmount * nvP2);
        const ev2 = (!oneSideOnly && hasPayout2) ? to2(payout2 * nvP2 - maxAmount * nvP1) : null;
        
        const maxEV = Math.max(ev1, ev2 ?? -Infinity);
        
        const calc = {
          isKelly: false,
          sportsbookOdds1: sbo1,
          sportsbookOdds2: sbo2,
          stake: maxAmount,
          noVigProb1: nvP1.toFixed(4),
          noVigProb2: nvP2.toFixed(4),
          fractionalProb1: fp1,
          fractionalProb2: fp2,
          payout1: payout1,
          payout2: (!oneSideOnly && hasPayout2) ? payout2 : null,
          ev1: ev1,
          ev2: ev2,
          maxEV: maxEV,
          label1: labels[0],
          label2: labels[1]
        };
        
        saveToHistory(calc);
        
        if (showAll) {
          r += `${labels[0]} Payout: ${payout1} RAX<br>`;
          if (ev2 !== null) r += `${labels[1]} Payout: ${payout2} RAX<br>`;
          r += `<br>`;
        }
        
        r += `<strong>${labels[0]} Expected Value: ${ev1} RAX${ev1 === maxEV ? ' ✅' : ''}</strong><br>`;
        if (ev2 !== null) {
          r += `<strong>${labels[1]} Expected Value: ${ev2} RAX${ev2 === maxEV ? ' ✅' : ''}</strong><br>`;
        }
      }
      
      $('result').innerHTML = r;
    }

    function clearInputs() {
      ['sportsbookOddsInput1', 'sportsbookOddsInput2', 'payoutInput1', 'payoutInput2', 'communityPercent1', 'communityPercent2'].forEach(i => $(i).value = '');
      $('stakeInput').value = '100';
      $('toggleOutput').checked = false;
      $('result').innerHTML = '';
    }

    window.addEventListener('DOMContentLoaded', () => {
      $('toggleHistory').onchange = toggleHistorySection;
      
      $('oneSideOnly').onchange = () => {
        const team2Inputs = document.querySelectorAll('.team2-inputs');
        team2Inputs.forEach(el => {
          el.style.display = $('oneSideOnly').checked ? 'none' : 'block';
        });
      };
      
      $('calculateWager').onchange = () => {
        const isKelly = $('calculateWager').checked;
        const payoutInputs = document.querySelectorAll('.payout-inputs');
        const kellyInputs = document.querySelectorAll('.kelly-inputs');
        
        payoutInputs.forEach(el => {
          el.style.display = isKelly ? 'none' : 'block';
        });
        kellyInputs.forEach(el => {
          el.style.display = isKelly ? 'block' : 'none';
        });
        
        // Update placeholder text
        $('stakeInput').placeholder = isKelly 
          ? 'Enter Max Amount Willing to Bet (RAX)' 
          : 'Enter Stake Amount (RAX)';
      };
      
      $('kellySlider').oninput = () => {
        $('kellyValue').textContent = $('kellySlider').value + '%';
      };
      
      updateHistoryDisplay();
    });
  </script>
</body>
</html>
