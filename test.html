<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4-Pick Pool EV Calculator</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: sans-serif;
      padding: 2rem;
    }
    input {
      width: 80px;
      padding: 5px;
      margin: 5px;
      background: #222;
      color: #fff;
      border: 1px solid #444;
    }
    table {
      border-collapse: collapse;
      margin-top: 20px;
      width: 100%;
    }
    th, td {
      border: 1px solid #555;
      padding: 6px;
      text-align: center;
    }
    th {
      background-color: #222;
    }
    button {
      background: #4caf50;
      border: none;
      padding: 10px 20px;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>4-Pick Pool EV Calculator</h1>
  <p>Enter % of entrants picking each team and American odds for both teams.</p>
  <div id="inputs"></div>
  <label>Total Entrants: <input type="number" id="totalEntrants" value="4600" /></label><br />
  <label><input type="checkbox" id="showExtras"> Show odds, probabilities, payouts</label><br />
  <button onclick="calculateEV()">Calculate EV</button>
  <div id="results"></div>
  <div id="extras"></div>

  <script>
    const inputContainer = document.getElementById('inputs');
    for (let i = 0; i < 4; i++) {
      inputContainer.innerHTML += `
        <div>
          Game ${i + 1} - L${i + 1} vs R${i + 1}:<br>
          % Picked L${i + 1}: <input id="pickL${i}" type="number" value="50"> 
          % Picked R${i + 1}: <input id="pickR${i}" type="number" value="50"> <br>
          Odds L${i + 1} (e.g. -120): <input id="oddsL${i}" type="number" value="-110"> 
          Odds R${i + 1} (e.g. +100): <input id="oddsR${i}" type="number" value="-110"> 
        </div><br>
      `;
    }

    function americanToImplied(odds) {
      return odds < 0 ? (-odds) / (-odds + 100) : 100 / (odds + 100);
    }

    function calculateNoVigProb(p1, p2) {
      const total = p1 + p2;
      return [p1 / total, p2 / total];
    }

    function calculateEV() {
      const totalEntrants = parseInt(document.getElementById('totalEntrants').value);
      const showExtras = document.getElementById('showExtras').checked;
      let pickPercents = [], winProbs = [], extraData = [];

      for (let i = 0; i < 4; i++) {
        let lPick = parseFloat(document.getElementById(`pickL${i}`).value) / 100;
        let rPick = parseFloat(document.getElementById(`pickR${i}`).value) / 100;
        let lOdds = parseFloat(document.getElementById(`oddsL${i}`).value);
        let rOdds = parseFloat(document.getElementById(`oddsR${i}`).value);

        pickPercents.push([lPick, rPick]);

        const impL = americanToImplied(lOdds);
        const impR = americanToImplied(rOdds);
        const [probL, probR] = calculateNoVigProb(impL, impR);
        winProbs.push([probL, probR]);
        extraData.push({ lOdds, rOdds, impL, impR, probL, probR });
      }

      const combos = Array.from({length: 16}, (_, i) => i.toString(2).padStart(4, '0'));
      let counts = {}, results = [];

      combos.forEach(combo => {
        let prob = 1;
        for (let i = 0; i < 4; i++) {
          let pick = +combo[i];
          prob *= pickPercents[i][pick];
        }
        counts[combo] = (totalEntrants - 1) * prob;
      });

      combos.forEach(userPick => {
        let EV = 0;
        combos.forEach(outcome => {
          let p = 1;
          for (let i = 0; i < 4; i++) {
            let win = +outcome[i];
            p *= winProbs[i][win];
          }

          const match = [...userPick].filter((bit, i) => bit === outcome[i]).length;
          const isTier1 = match === 4;
          const isTier2 = match === 3;

          let w1 = counts[outcome] || 0;
          if (userPick === outcome) w1++;

          let w2 = 0;
          combos.forEach(other => {
            const m = [...other].filter((bit, i) => bit === outcome[i]).length;
            if (m === 3) w2 += counts[other] || 0;
          });
          if (isTier2) w2++;

          const losers = totalEntrants - w1 - w2;
          const pool = 100 * totalEntrants;
          const shares = w1 + 0.5 * w2;
          const shareValue = pool / shares;

          let gain = -100;
          if (isTier1) gain = Math.min(Math.floor(shareValue), 800);
          else if (isTier2) gain = Math.min(Math.floor(shareValue / 2), 600);

          EV += p * gain;
        });
        results.push({ combo: userPick, ev: EV });
      });

      results.sort((a, b) => b.ev - a.ev);

      const table = `
        <table>
          <tr><th>Rank</th><th>Pick (L/R)</th><th>Expected Value</th></tr>
          ${results.map((r, i) => `
            <tr><td>${i + 1}</td><td>${r.combo.replace(/./g, b => b === '0' ? 'L' : 'R')}</td><td>${r.ev.toFixed(2)}</td></tr>
          `).join('')}
        </table>
      `;
      document.getElementById('results').innerHTML = table;

      if (showExtras) {
        const extraTable = `
          <table>
            <tr><th>Game</th><th>Odds L</th><th>Odds R</th><th>Imp. L</th><th>Imp. R</th><th>No-Vig L</th><th>No-Vig R</th></tr>
            ${extraData.map((row, i) => `
              <tr><td>${i + 1}</td><td>${row.lOdds}</td><td>${row.rOdds}</td>
              <td>${(row.impL * 100).toFixed(1)}%</td><td>${(row.impR * 100).toFixed(1)}%</td>
              <td>${(row.probL * 100).toFixed(1)}%</td><td>${(row.probR * 100).toFixed(1)}%</td></tr>
            `).join('')}
          </table>
        `;
        document.getElementById('extras').innerHTML = extraTable;
      } else {
        document.getElementById('extras').innerHTML = '';
      }
    }
  </script>
</body>
</html>
