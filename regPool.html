<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pool EV Calculator</title>
  <style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: sans-serif;
    line-height: 1.6;
    background-color: black;
    color: lightgray;
    text-align: center;
  }

  .container {
    max-width: 72rem;
    margin: 0 auto;
    padding: 1rem;
  }

  .heading {
    font-size: 1.875rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  .subheading {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
  }

  .section-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .instructions {
    background-color: #333;
    padding: 1rem;
    border-radius: 25px;
    margin-bottom: 1.5rem;
    border: 2px solid #555;
  }

  .instructions p {
    margin-bottom: 0.5rem;
  }

  .form-control {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: lightgray;
    margin-bottom: 0.25rem;
  }

  .form-input {
    border: 2px solid #555;
    border-radius: 25px;
    padding: 15px;
    width: 100%;
    font-size: 16px;
    background-color: #333;
    color: lightgray;
    transition: border-color 0.3s;
  }

  .form-input:focus {
    border-color: #007BFF;
    outline: none;
  }

  .form-input:disabled {
    background-color: #222;
    color: #666;
    border-color: #333;
    cursor: not-allowed;
  }

  .form-select {
    border: 2px solid #555;
    border-radius: 25px;
    padding: 15px;
    width: 100%;
    font-size: 16px;
    background-color: #333;
    color: lightgray;
    transition: border-color 0.3s;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='lightgray' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 1em;
  }

  .form-select:focus {
    border-color: #007BFF;
    outline: none;
  }

  .form-select:disabled {
    background-color: #222;
    color: #666;
    border-color: #333;
    cursor: not-allowed;
  }

  .game-selector {
    margin-bottom: 1.5rem;
    max-width: 300px;
    margin-left: auto;
    margin-right: auto;
  }

  .games-grid {
    display: grid;
    grid-template-columns: repeat(1, minmax(0, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .card {
    border: 2px solid #555;
    border-radius: 25px;
    padding: 1rem;
    background-color: #222;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }

  .game-card {
    border: 2px solid #555;
    border-radius: 25px;
    padding: 1rem;
    background-color: #222;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    position: relative;
  }

  .game-card.decided {
    background-color: #1a1a1a;
    border-color: #444;
  }

  .game-card.decided .section-title::after {
    content: " (DECIDED)";
    color: #ffa500;
    font-weight: normal;
    font-size: 0.9rem;
  }

  .decided-control {
    background-color: #2a2a2a;
    border: 1px solid #555;
    border-radius: 15px;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .decided-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .decided-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #ffa500;
  }

  .winner-selection {
    display: none;
    background-color: #333;
    border-radius: 10px;
    padding: 0.75rem;
    margin-top: 0.5rem;
  }

  .winner-selection.show {
    display: block;
  }

  .winner-options {
    display: flex;
    gap: 1rem;
    justify-content: center;
    align-items: center;
  }

  .winner-option {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    color: lightgray;
  }

  .winner-option input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: #10b981;
  }

  .teams-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 1rem;
  }

  .team-card {
    border: 2px solid #555;
    border-radius: 25px;
    padding: 0.75rem;
    background-color: #333;
  }

  .push-inputs {
    margin-top: 1rem;
    padding: 1rem;
    background-color: #2a2a2a;
    border-radius: 15px;
    border: 1px solid #555;
  }

  .push-display {
    text-align: center;
    font-weight: 600;
    color: #ffa500;
    margin-top: 0.5rem;
  }

  .btn {
    border: none;
    border-radius: 25px;
    padding: 15px;
    cursor: pointer;
    font-size: 16px;
    width: 100%;
    transition: background-color 0.3s;
  }

  .btn-default {
    background-color: #444;
    color: white;
  }

  .btn-primary {
    background-color: #6f42c1;
    color: white;
  }

  .btn-primary:hover {
    background-color: #5a32a3;
  }

  .calculate-btn {
    background-color: #6f42c1;
    color: white;
    padding: 15px;
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    border-radius: 25px;
  }

  .calculate-btn:hover {
    background-color: #5a32a3;
  }

  .results-grid {
    display: grid;
    grid-template-columns: repeat(1, minmax(0, 1fr));
    gap: 1.5rem;
  }

  .info-box {
    background-color: #333;
    padding: 1rem;
    border-radius: 25px;
    margin-bottom: 1rem;
    border: 2px solid #555;
  }

  .table-container {
    background-color: #333;
    padding: 1rem;
    border-radius: 25px;
    max-height: 30rem;
    overflow-y: auto;
    border: 2px solid #555;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
    color: lightgray;
  }

  th {
    text-align: left;
    padding: 0.5rem;
    border-bottom: 1px solid #555;
    position: sticky;
    top: 0;
    background-color: #222;
    color: lightgray;
    cursor: pointer;
  }

  td {
    padding: 0.5rem;
  }

  tr:nth-child(even) {
    background-color: #2a2a2a;
  }

  .text-note {
    font-size: 0.75rem;
    color: #aaa;
    margin-top: 0.5rem;
  }

  .controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .control-group {
    background-color: #333;
    border: 2px solid #555;
    border-radius: 25px;
    padding: 1rem;
  }

  .control-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #ffffff;
    font-size: 0.9rem;
  }

  .control-group input[type="number"] {
    width: 80px;
    padding: 0.4rem;
    background-color: #333;
    border: 1px solid #555;
    border-radius: 4px;
    color: lightgray;
    font-size: 0.9rem;
  }

  .control-group input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: #6f42c1;
  }

  .copy-btn {
    background: linear-gradient(45deg, #10b981, #059669);
    border: none;
    padding: 0.6rem 1.5rem;
    color: white;
    font-size: 0.9rem;
    font-weight: 600;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-left: 1rem;
  }

  .copy-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  }

  .ev-positive {
    color: #10b981;
    font-weight: bold;
  }

  .ev-negative {
    color: #ef4444;
  }

  @media (min-width: 768px) {
    .games-grid.two-games {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .games-grid.three-games {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
    .games-grid.four-games {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .results-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }
  </style>
</head>
<body>
  <div class="container" id="app">
    <h1 class="heading">Pool EV Calculator</h1>
    
    <div class="game-selector">
      <label class="form-label">Number of Games</label>
      <select class="form-select" id="game-count-select">
        <option value="2">2 Games</option>
        <option value="3">3 Games</option>
        <option value="4">4 Games</option>
      </select>
    </div>

    <div class="instructions" id="instructions-container">
      <h2 class="section-title">Instructions</h2>
      <p>1. Enter odds (American format) and selection percentages for each game.</p>
      <p>2. Mark games as "Decided" to set actual winners and see updated EVs.</p>
      <p>3. Click "Calculate" to see expected values for all combinations.</p>
    </div>

    <form id="calculator-form">
      <div class="games-grid two-games" id="games-container">
        <!-- Games will be rendered here -->
      </div>

      <div class="controls" id="controls-container">
        <!-- Controls will be dynamically added based on game count -->
      </div>

      <button type="button" class="btn calculate-btn" id="calculate-btn">Calculate Results</button>
    </form>

    <div id="results-container" style="display: none;"></div>
  </div>

  <script>
    function autofillRightPercents(gameId, changedSide) {
      const leftInput = document.getElementById(`game-${gameId}-team1-selection`);
      const rightInput = document.getElementById(`game-${gameId}-team2-selection`);
      if (!leftInput || !rightInput) return;
      
      let val = parseFloat(changedSide === 'left' ? leftInput.value : rightInput.value) || 0;
      val = Math.min(100, Math.max(0, val));
      if (changedSide === 'left') {
        rightInput.value = (100 - val).toFixed(0);
      } else {
        leftInput.value = (100 - val).toFixed(0);
      }
    }

    class UnifiedPoolCalculator {
      constructor() {
        console.log('Calculator initializing...');
        this.state = {
          gameCount: 2,
          games: [],
          results: { combinations: [], payouts: {} },
          totalEntrants: 4600,
          maxPayout: 400,
          sortBy: 'expectedValue',
          sortDirection: 'desc',
          showExtras: false
        };

        try {
          this.bindEvents();
          this.initializeGames();
          this.renderGames();
          console.log('Calculator initialized successfully');
        } catch (error) {
          console.error('Error initializing calculator:', error);
        }
      }

      bindEvents() {
        const gameCountSelect = document.getElementById('game-count-select');
        if (gameCountSelect) {
          gameCountSelect.addEventListener('change', (e) => {
            this.state.gameCount = parseInt(e.target.value);
            this.updateCalculator();
          });
        }

        const calculateBtn = document.getElementById('calculate-btn');
        if (calculateBtn) {
          calculateBtn.addEventListener('click', () => {
            this.calculateAllCombinations();
          });
        }
      }

      updateCalculator() {
        this.initializeGames();
        this.renderGames();
        document.getElementById('results-container').style.display = 'none';
      }

      initializeGames() {
        this.state.games = [];
        for (let i = 1; i <= this.state.gameCount; i++) {
          this.state.games.push({
            id: i,
            team1: { 
              name: `L${i}`, 
              odds: -110, 
              selectionPercentage: 50, 
              noVigOdds: -100, 
              noVigProbability: 0.5 
            },
            team2: { 
              name: `R${i}`, 
              odds: -110, 
              selectionPercentage: 50, 
              noVigOdds: -100, 
              noVigProbability: 0.5 
            },
            decided: false,
            team1Winner: false,
            team2Winner: false
          });
        }

        // Set defaults based on game count
        if (this.state.gameCount === 2) {
          this.state.totalEntrants = 4600;
          this.state.maxPayout = 400;
        } else if (this.state.gameCount === 3) {
          this.state.totalEntrants = 9450;
          this.state.maxPayout = 600;
        } else if (this.state.gameCount === 4) {
          this.state.totalEntrants = 4600;
          this.state.maxPayout = 800;
        }
        
        console.log('Games initialized:', this.state.games);
      }

      renderGames() {
        const container = document.getElementById('games-container');
        if (!container) {
          console.error('Games container not found');
          return;
        }

        container.innerHTML = '';
        console.log('Rendering games:', this.state.games.length);

        this.state.games.forEach(game => {
          const gameCard = document.createElement('div');
          gameCard.className = `game-card ${game.decided ? 'decided' : ''}`;
          
          gameCard.innerHTML = `
            <h3 class="section-title">Game ${game.id}</h3>
            
            <div class="decided-control">
              <div class="decided-checkbox">
                <input type="checkbox" id="game-${game.id}-decided" ${game.decided ? 'checked' : ''}>
                <label for="game-${game.id}-decided">Game Decided</label>
              </div>
              <div class="winner-selection ${game.decided ? 'show' : ''}" id="game-${game.id}-winner-selection">
                <div style="margin-bottom: 0.5rem; font-size: 0.9rem; color: #ccc;">Select Winner(s):</div>
                <div class="winner-options">
                  <div class="winner-option">
                    <input type="checkbox" id="game-${game.id}-team1-winner" ${game.team1Winner ? 'checked' : ''}>
                    <label for="game-${game.id}-team1-winner">${game.team1.name} Wins</label>
                  </div>
                  <div class="winner-option">
                    <input type="checkbox" id="game-${game.id}-team2-winner" ${game.team2Winner ? 'checked' : ''}>
                    <label for="game-${game.id}-team2-winner">${game.team2.name} Wins</label>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="teams-grid">
              <div class="team-card">
                <div class="form-control">
                  <label class="form-label">${game.team1.name}</label>
                </div>
                <div class="form-control">
                  <label class="form-label">American Odds</label>
                  <input type="number" class="form-input" id="game-${game.id}-team1-odds" value="${game.team1.odds}" ${game.decided ? 'disabled' : ''} />
                </div>
                <div class="form-control">
                  <label class="form-label">Selection %</label>
                  <input type="number" class="form-input" id="game-${game.id}-team1-selection"
                    value="${game.team1.selectionPercentage}" min="0" max="100"
                    oninput="autofillRightPercents(${game.id}, 'left')" />
                </div>
                <div class="form-control">
                  <label class="form-label" id="game-${game.id}-team1-odds-display">${game.decided ? `Result: ${game.team1Winner ? 'WON' : 'LOST'}` : `No-Vig Odds: ${game.team1.noVigOdds}`}</label>
                  <div class="text-note" id="game-${game.id}-team1-prob-display">${game.decided ? `Probability: ${(game.team1.noVigProbability * 100).toFixed(0)}%` : `No-Vig Probability: ${(game.team1.noVigProbability * 100).toFixed(2)}%`}</div>
                </div>
              </div>
              <div class="team-card">
                <div class="form-control">
                  <label class="form-label">${game.team2.name}</label>
                </div>
                <div class="form-control">
                  <label class="form-label">American Odds</label>
                  <input type="number" class="form-input" id="game-${game.id}-team2-odds" value="${game.team2.odds}" ${game.decided ? 'disabled' : ''} />
                </div>
                <div class="form-control">
                  <label class="form-label">Selection %</label>
                  <input type="number" class="form-input" id="game-${game.id}-team2-selection"
                    value="${game.team2.selectionPercentage}" min="0" max="100"
                    oninput="autofillRightPercents(${game.id}, 'right')" />
                </div>
                <div class="form-control">
                  <label class="form-label" id="game-${game.id}-team2-odds-display">${game.decided ? `Result: ${game.team2Winner ? 'WON' : 'LOST'}` : `No-Vig Odds: ${game.team2.noVigOdds}`}</label>
                  <div class="text-note" id="game-${game.id}-team2-prob-display">${game.decided ? `Probability: ${(game.team2.noVigProbability * 100).toFixed(0)}%` : `No-Vig Probability: ${(game.team2.noVigProbability * 100).toFixed(2)}%`}</div>
                </div>
              </div>
            </div>
          `;
          
          container.appendChild(gameCard);

          // Add event listeners
          this.attachGameEventListeners(game.id);
        });
      }

      attachGameEventListeners(gameId) {
        const decidedCheckbox = document.getElementById(`game-${gameId}-decided`);
        if (decidedCheckbox) {
          decidedCheckbox.addEventListener('change', () => this.toggleGameDecided(gameId));
        }

        const team1WinnerCheckbox = document.getElementById(`game-${gameId}-team1-winner`);
        const team2WinnerCheckbox = document.getElementById(`game-${gameId}-team2-winner`);
        if (team1WinnerCheckbox && team2WinnerCheckbox) {
          team1WinnerCheckbox.addEventListener('change', () => this.updateWinnerSelection(gameId, 'team1'));
          team2WinnerCheckbox.addEventListener('change', () => this.updateWinnerSelection(gameId, 'team2'));
        }
      }

      toggleGameDecided(gameId) {
        const game = this.state.games.find(g => g.id === gameId);
        const decidedCheckbox = document.getElementById(`game-${gameId}-decided`);
        const winnerSelection = document.getElementById(`game-${gameId}-winner-selection`);
        const gameCard = decidedCheckbox.closest('.game-card');
        
        game.decided = decidedCheckbox.checked;
        
        if (game.decided) {
          winnerSelection.classList.add('show');
          gameCard.classList.add('decided');
          this.toggleGameInputs(gameId, true);
        } else {
          winnerSelection.classList.remove('show');
          gameCard.classList.remove('decided');
          this.toggleGameInputs(gameId, false);
          game.team1Winner = false;
          game.team2Winner = false;
          document.getElementById(`game-${gameId}-team1-winner`).checked = false;
          document.getElementById(`game-${gameId}-team2-winner`).checked = false;
        }
        
        this.updateGameProbabilities(gameId);
      }

      toggleGameInputs(gameId, disabled) {
        const oddsInputs = [
          document.getElementById(`game-${gameId}-team1-odds`),
          document.getElementById(`game-${gameId}-team2-odds`)
        ];

        oddsInputs.forEach(input => {
          if (input) input.disabled = disabled;
        });
      }

      updateWinnerSelection(gameId, team) {
        const game = this.state.games.find(g => g.id === gameId);
        const team1Checkbox = document.getElementById(`game-${gameId}-team1-winner`);
        const team2Checkbox = document.getElementById(`game-${gameId}-team2-winner`);
        
        if (team === 'team1') {
          game.team1Winner = team1Checkbox.checked;
        } else if (team === 'team2') {
          game.team2Winner = team2Checkbox.checked;
        }
        
        this.updateGameProbabilities(gameId);
      }

      updateGameProbabilities(gameId) {
        const game = this.state.games.find(g => g.id === gameId);
        
        if (game.decided) {
          if (game.team1Winner && game.team2Winner) {
            // PUSH: Both sides win, everyone gets this pick correct
            game.team1.noVigProbability = 1.0;
            game.team2.noVigProbability = 1.0;
          } else if (game.team1Winner) {
            // Team1 wins, Team2 loses
            game.team1.noVigProbability = 1.0;
            game.team2.noVigProbability = 0.0;
          } else if (game.team2Winner) {
            // Team2 wins, Team1 loses
            game.team1.noVigProbability = 0.0;
            game.team2.noVigProbability = 1.0;
          } else {
            // No winner selected (shouldn't happen but fallback)
            game.team1.noVigProbability = 0.0;
            game.team2.noVigProbability = 0.0;
          }
        } else {
          // Calculate no-vig probabilities from odds
          const team1Prob = this.oddsToImpliedProbability(game.team1.odds);
          const team2Prob = this.oddsToImpliedProbability(game.team2.odds);
          const overround = team1Prob + team2Prob;
          
          game.team1.noVigProbability = team1Prob / overround;
          game.team2.noVigProbability = team2Prob / overround;
        }

        // Update display
        const team1OddsDisplay = document.getElementById(`game-${gameId}-team1-odds-display`);
        const team1ProbDisplay = document.getElementById(`game-${gameId}-team1-prob-display`);
        const team2OddsDisplay = document.getElementById(`game-${gameId}-team2-odds-display`);
        const team2ProbDisplay = document.getElementById(`game-${gameId}-team2-prob-display`);

        if (game.decided) {
          if (game.team1Winner && game.team2Winner) {
            // Push scenario
            team1OddsDisplay.textContent = `Result: PUSH`;
            team1ProbDisplay.textContent = `Probability: 100% (Push)`;
            team2OddsDisplay.textContent = `Result: PUSH`;
            team2ProbDisplay.textContent = `Probability: 100% (Push)`;
          } else {
            // Regular win/loss
            team1OddsDisplay.textContent = `Result: ${game.team1Winner ? 'WON' : 'LOST'}`;
            team1ProbDisplay.textContent = `Probability: ${(game.team1.noVigProbability * 100).toFixed(0)}%`;
            team2OddsDisplay.textContent = `Result: ${game.team2Winner ? 'WON' : 'LOST'}`;
            team2ProbDisplay.textContent = `Probability: ${(game.team2.noVigProbability * 100).toFixed(0)}%`;
          }
        } else {
          team1OddsDisplay.textContent = `No-Vig Odds: ${this.probabilityToAmericanOdds(game.team1.noVigProbability)}`;
          team1ProbDisplay.textContent = `No-Vig Probability: ${(game.team1.noVigProbability * 100).toFixed(2)}%`;
          team2OddsDisplay.textContent = `No-Vig Odds: ${this.probabilityToAmericanOdds(game.team2.noVigProbability)}`;
          team2ProbDisplay.textContent = `No-Vig Probability: ${(game.team2.noVigProbability * 100).toFixed(2)}%`;
        }
      }

      oddsToImpliedProbability(odds) {
        return odds > 0 ? 100 / (odds + 100) : Math.abs(odds) / (Math.abs(odds) + 100);
      }

      probabilityToAmericanOdds(prob) {
        if (prob <= 0 || prob >= 1) return 0;
        return prob > 0.5 ? Math.round(-100 * prob / (1 - prob)) : Math.round(100 * (1 - prob) / prob);
      }

      calculateAllCombinations() {
        console.log('Calculating combinations...');
        
        // Collect form data
        this.state.games.forEach(game => {
          const team1OddsInput = document.getElementById(`game-${game.id}-team1-odds`);
          const team1SelectionInput = document.getElementById(`game-${game.id}-team1-selection`);
          const team2OddsInput = document.getElementById(`game-${game.id}-team2-odds`);
          const team2SelectionInput = document.getElementById(`game-${game.id}-team2-selection`);
          
          if (team1OddsInput) game.team1.odds = parseInt(team1OddsInput.value) || -110;
          if (team1SelectionInput) game.team1.selectionPercentage = parseInt(team1SelectionInput.value) || 50;
          if (team2OddsInput) game.team2.odds = parseInt(team2OddsInput.value) || -110;
          if (team2SelectionInput) game.team2.selectionPercentage = parseInt(team2SelectionInput.value) || 50;
          
          this.updateGameProbabilities(game.id);
        });

        // Generate combinations
        const combinations = this.generateCombinations();
        const withSelections = this.calculateSelections(combinations);
        const withProbabilities = this.calculateWinProbabilities(withSelections);
        const results = this.calculatePayouts(withProbabilities);
        
        this.state.results = { combinations: results };
        this.renderResults();
      }

      generateCombinations() {
        let combos = [
          { teams: [this.state.games[0].team1], side: ['team1'] },
          { teams: [this.state.games[0].team2], side: ['team2'] }
        ];

        for (let i = 1; i < this.state.games.length; i++) {
          const game = this.state.games[i];
          combos = combos.flatMap(combo => [
            { teams: [...combo.teams, game.team1], side: [...combo.side, 'team1'] },
            { teams: [...combo.teams, game.team2], side: [...combo.side, 'team2'] }
          ]);
        }

        return combos;
      }

      calculateSelections(combos) {
        return combos.map(combo => {
          let pct = 1;
          
          combo.teams.forEach((team, i) => {
            const game = this.state.games[i];
            const side = combo.side[i];
            
            if (game.decided && game.team1Winner && game.team2Winner) {
              // Push: Everyone who bet on this game gets it right
              // So this combination gets the full percentage of people who bet on either side
              const totalGameSelections = game.team1.selectionPercentage + game.team2.selectionPercentage;
              pct *= (totalGameSelections / 100);
            } else {
              // Normal game: only the people who picked this specific side
              const total = game.team1.selectionPercentage + game.team2.selectionPercentage;
              pct *= total ? (game[side].selectionPercentage / total) : 0.5;
            }
          });
          
          return {
            ...combo,
            selectionPercentage: pct * 100,
            numberOfSelections: Math.round(this.state.totalEntrants * pct)
          };
        });
      }

      calculateWinProbabilities(combos) {
        return combos.map(combo => {
          const prob = combo.teams.reduce((acc, t) => acc * t.noVigProbability, 1);
          return { ...combo, winProbability: prob * 100 };
        });
      }

      calculatePayouts(combos) {
        if (this.state.gameCount === 4) {
          return this.calculateFourGamePayouts(combos);
        } else {
          // For 2 and 3 game modes: only pay out if ALL games are correct
          return combos.map(combo => {
            const winners = combo.numberOfSelections;
            const payout = Math.min(
              winners > 0 ? (this.state.totalEntrants * 100) / winners : 0,
              this.state.maxPayout
            );
            const winP = combo.winProbability / 100;
            const ev = (winP * payout) - ((1 - winP) * 100);
            return { ...combo, payout, expectedValue: ev };
          });
        }
      }

      calculateFourGamePayouts(combos) {
        // Generate all possible outcomes for 4 games
        const allOutcomes = this.generateAllOutcomesFour();
        
        // Calculate selection counts for each combo
        let counts = {};
        combos.forEach(combo => {
          const pickString = combo.side.map(s => s === 'team1' ? '0' : '1').join('');
          let prob = 1;
          combo.teams.forEach((team, i) => {
            const game = this.state.games[i];
            const total = game.team1.selectionPercentage + game.team2.selectionPercentage || 100;
            prob *= (team.selectionPercentage / total);
          });
          counts[pickString] = (this.state.totalEntrants - 1) * prob;
        });

        return combos.map(combo => {
          let EV = 0;
          const pickString = combo.side.map(s => s === 'team1' ? '0' : '1').join('');

          allOutcomes.forEach(outcome => {
            // Calculate outcome probability
            let p = 1;
            for (let i = 0; i < 4; i++) {
              const game = this.state.games[i];
              const gameOutcome = outcome[i];
              if (gameOutcome === '0') {
                p *= game.team1.noVigProbability;
              } else {
                p *= game.team2.noVigProbability;
              }
            }

            // Calculate matches for this user pick vs outcome
            const matches = this.calculateMatchesFour(pickString, outcome);
            const isTier1 = matches === 4;
            const isTier2 = matches === 3;

            // Count winners in each tier for this outcome
            let w1 = 0; // 4/4 winners
            let w2 = 0; // 3/4 winners

            combos.forEach(otherCombo => {
              const otherPickString = otherCombo.side.map(s => s === 'team1' ? '0' : '1').join('');
              const otherMatches = this.calculateMatchesFour(otherPickString, outcome);
              const comboCount = counts[otherPickString] || 0;
              
              if (otherMatches === 4) {
                w1 += comboCount;
              } else if (otherMatches === 3) {
                w2 += comboCount;
              }
            });

            // Add current user if they qualify
            const userMatches = this.calculateMatchesFour(pickString, outcome);
            if (userMatches === 4) w1++;
            if (userMatches === 3) w2++;

            // Calculate payout
            const pool = 100 * this.state.totalEntrants;
            const shares = w1 + 0.5 * w2;
            const shareValue = shares > 0 ? pool / shares : 0;

            let gain = -100;
            if (isTier1) gain = Math.min(Math.floor(shareValue), 800);
            else if (isTier2) gain = Math.min(Math.floor(shareValue / 2), 600);

            EV += p * gain;
          });

          return { 
            ...combo, 
            expectedValue: EV,
            pickString
          };
        });
      }

      generateAllOutcomesFour() {
        let outcomes = [''];
        
        for (let i = 0; i < 4; i++) {
          const newOutcomes = [];
          outcomes.forEach(outcome => {
            newOutcomes.push(outcome + '0'); // L
            newOutcomes.push(outcome + '1'); // R
          });
          outcomes = newOutcomes;
        }
        
        return outcomes;
      }

      calculateMatchesFour(userPick, outcome) {
        let matches = 0;
        for (let i = 0; i < 4; i++) {
          const userChoice = userPick[i];
          const gameOutcome = outcome[i];
          
          if (userChoice === gameOutcome) {
            matches++;
          }
        }
        return matches;
      }

      renderResults() {
        const container = document.getElementById('results-container');
        const { combinations } = this.state.results;

        if (!combinations || combinations.length === 0) {
          container.style.display = 'none';
          return;
        }

        const sorted = [...combinations].sort((a, b) => b.expectedValue - a.expectedValue);

        let tableHTML = '';
        
        if (this.state.gameCount === 4) {
          // For 4 games, show tier payouts
          const avgShares = this.state.totalEntrants / 16;
          const avgShareValue = (100 * this.state.totalEntrants) / avgShares;
          const tier1Payout = Math.min(Math.floor(avgShareValue), 800);
          const tier2Payout = Math.min(Math.floor(avgShareValue / 2), 600);

          tableHTML = `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Picks</th>
                    <th>Win %</th>
                    <th># Selections</th>
                    <th>3/4 Payout</th>
                    <th>4/4 Payout</th>
                    <th>EV</th>
                  </tr>
                </thead>
                <tbody>
                  ${sorted.map(combo => {
                    const picks = combo.pickString ? combo.pickString.split('').map(v => v === '0' ? 'L' : 'R').join('') : combo.teams.map(t => t.name.replace(/[0-9]/g, '')).join('');
                    const evClass = combo.expectedValue > 0 ? 'ev-positive' : 'ev-negative';
                    
                    return `
                      <tr>
                        <td>${picks}</td>
                        <td>${combo.winProbability.toFixed(2)}%</td>
                        <td>${combo.numberOfSelections}</td>
                        <td>${tier2Payout}</td>
                        <td>${tier1Payout}</td>
                        <td class="${evClass}">${combo.expectedValue.toFixed(2)}</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          `;
        } else {
          // For 2 and 3 games, show regular format
          const avgWinners = this.state.gameCount === 2 ? this.state.totalEntrants / 4 : this.state.totalEntrants / 8;
          const avgPayout = Math.min((this.state.totalEntrants * 100) / avgWinners, this.state.maxPayout);

          tableHTML = `
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Picks</th>
                    <th>Win %</th>
                    <th># Selections</th>
                    <th>Avg Payout</th>
                    <th>EV</th>
                  </tr>
                </thead>
                <tbody>
                  ${sorted.map(combo => {
                    const picks = combo.teams.map(t => t.name.replace(/[0-9]/g, '')).join('');
                    const evClass = combo.expectedValue > 0 ? 'ev-positive' : 'ev-negative';
                    
                    return `
                      <tr>
                        <td>${picks}</td>
                        <td>${combo.winProbability.toFixed(2)}%</td>
                        <td>${combo.numberOfSelections}</td>
                        <td>${Math.round(avgPayout)}</td>
                        <td class="${evClass}">${combo.expectedValue.toFixed(2)}</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          `;
        }

        const infoNote = `
          <div class="info-box">
            <p><strong>Win Probabilities Based On:</strong><br>
            No-vig odds are used for calculations to remove bookmakers' edge. For decided games, actual results are used (100% for winners, 0% for losers).</p>
          </div>
        `;

        const copyButton = `<button class="btn btn-default copy-btn" id="copy-results-btn">Copy Top Results</button>`;

        container.innerHTML = `
          <div class="card">
            ${infoNote}
            <h2 class="subheading">All Combinations and Payouts</h2>
            ${tableHTML}
            ${copyButton}
          </div>
        `;

        // Add copy button event listener
        const copyBtn = document.getElementById('copy-results-btn');
        if (copyBtn) {
          copyBtn.addEventListener('click', () => this.copyTopResults());
        }

        container.style.display = 'block';
      }

      copyTopResults() {
        const { combinations } = this.state.results;
        if (!combinations.length) return alert("No results to copy.");
        
        let text = '';
        
        if (this.state.gameCount === 4) {
          // For 4 games, calculate 3/4+ probability
          text = combinations.map(combo => {
            const picks = combo.pickString ? combo.pickString.split('').map(v => v === '0' ? 'L' : 'R').join('') : combo.teams.map(t => t.name.replace(/[0-9]/g, '')).join('');
            
            // Calculate 3/4+ probability for this combo
            let prob3Plus = 0;
            const allOutcomes = this.generateAllOutcomesFour();
            const pickString = combo.pickString || combo.side.map(s => s === 'team1' ? '0' : '1').join('');
            
            allOutcomes.forEach(outcome => {
              let outcomeProb = 1;
              for (let i = 0; i < 4; i++) {
                const game = this.state.games[i];
                const gameOutcome = outcome[i];
                if (gameOutcome === '0') {
                  outcomeProb *= game.team1.noVigProbability;
                } else {
                  outcomeProb *= game.team2.noVigProbability;
                }
              }
              const matches = this.calculateMatchesFour(pickString, outcome);
              if (matches >= 3) prob3Plus += outcomeProb;
            });
            
            return `${picks} - ${(prob3Plus * 100).toFixed(2)}% - (${combo.expectedValue.toFixed(2)})`;
          }).join('\n');
        } else {
          text = combinations.map(combo => {
            const pick = combo.teams.map(t => t.name.replace(/[0-9]/g, '')).join('');
            return `${pick} - ${combo.winProbability.toFixed(2)}% - (${combo.expectedValue.toFixed(2)})`;
          }).join('\n');
        }
        
        navigator.clipboard.writeText(text)
          .then(() => alert("Results copied to clipboard!"))
          .catch(err => alert("Copy failed."));
      }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, initializing calculator...');
      try {
        window.app = new UnifiedPoolCalculator();
      } catch (error) {
        console.error('Failed to initialize calculator:', error);
        document.body.innerHTML = '<div style="color: red; padding: 20px;">Error loading calculator. Please refresh the page.</div>';
      }
    });
  </script>
</body>
</html>
