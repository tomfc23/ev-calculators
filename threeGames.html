<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pool EV Calculator - 3 Matchups</title>
  <style>
   * {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: sans-serif;
  line-height: 1.6;
  background-color: black;
  color: lightgray;
  text-align: center;
}

.container {
  max-width: 72rem;
  margin: 0 auto;
  padding: 1rem;
}

.heading {
  font-size: 1.875rem;
  font-weight: 700;
  margin-bottom: 1.5rem;
  text-align: center;
}

.subheading {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 1rem;
}

.section-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.instructions {
  background-color: #333;
  padding: 1rem;
  border-radius: 25px;
  margin-bottom: 1.5rem;
  border: 2px solid #555;
}

.instructions p {
  margin-bottom: 0.5rem;
}

.form-control {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  font-size: 0.875rem;
  font-weight: 500;
  color: lightgray;
  margin-bottom: 0.25rem;
}

.form-input {
  border: 2px solid #555;
  border-radius: 25px;
  padding: 15px;
  width: 100%;
  font-size: 16px;
  background-color: #333;
  color: lightgray;
  transition: border-color 0.3s;
}

.form-input:focus {
  border-color: #007BFF;
  outline: none;
}

.games-grid {
  display: grid;
  grid-template-columns: repeat(1, minmax(0, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.card {
  border: 2px solid #555;
  border-radius: 25px;
  padding: 1rem;
  background-color: #222;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.game-card {
  border: 2px solid #555;
  border-radius: 25px;
  padding: 1rem;
  background-color: #222;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.teams-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 1rem;
}

.team-card {
  border: 2px solid #555;
  border-radius: 25px;
  padding: 0.75rem;
  background-color: #333;
}

.btn {
  border: none;
  border-radius: 25px;
  padding: 15px;
  cursor: pointer;
  font-size: 16px;
  width: 100%;
  transition: background-color 0.3s;
}

.btn-default {
  background-color: #444;
  color: white;
}

.btn-primary {
  background-color: #6f42c1;
  color: white;
}

.btn-primary:hover {
  background-color: #5a32a3;
}

.calculate-btn {
  background-color: #6f42c1;
  color: white;
  padding: 15px;
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 1.5rem;
  border-radius: 25px;
}

.calculate-btn:hover {
  background-color: #5a32a3;
}

.results-grid {
  display: grid;
  grid-template-columns: repeat(1, minmax(0, 1fr));
  gap: 1.5rem;
}

.info-box {
  background-color: #333;
  padding: 1rem;
  border-radius: 25px;
  margin-bottom: 1rem;
  border: 2px solid #555;
}

.table-container {
  background-color: #333;
  padding: 1rem;
  border-radius: 25px;
  max-height: 30rem;
  overflow-y: auto;
  border: 2px solid #555;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.875rem;
  color: lightgray;
}

th {
  text-align: left;
  padding: 0.5rem;
  border-bottom: 1px solid #555;
  position: sticky;
  top: 0;
  background-color: #222;
  color: lightgray;
}

td {
  padding: 0.5rem;
}

tr:nth-child(even) {
  background-color: #2a2a2a;
}

.explanation {
  border: 2px solid #555;
  border-radius: 25px;
  padding: 1.5rem;
  background-color: #222;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  margin-top: 2rem;
}

.code-block {
  background-color: #333;
  padding: 0.5rem;
  border-radius: 15px;
  overflow-x: auto;
  font-size: 0.875rem;
  margin-bottom: 0.5rem;
  white-space: pre-wrap;
  word-wrap: break-word;
  color: #ddd;
  border: 1px solid #555;
}

.text-note {
  font-size: 0.75rem;
  color: #aaa;
  margin-top: 0.5rem;
}

.sort-button {
  background: none;
  border: none;
  cursor: pointer;
  font-weight: bold;
  color: #858bf0;
  margin-left: 0.25rem;
}

a {
  color: #858bf0;
}

@media (min-width: 768px) {
  .games-grid, .results-grid {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
}
  </style>
</head>
<body>
  <div class="container" id="app">
    <h1 class="heading">Pool EV Calculator - 3 Matchups</h1>
    <div class="instructions">
      <h2 class="section-title">Instructions</h2>
      <p>1. Enter the details for each of the 3 games including odds (American format), and selection percentages.</p>
      <p>2. Click "Calculate" to see all combinations with their expected values, probabilities, and potential payouts.</p>
      <p>3. Total pool entrants is set to 9,450. Payouts are only awarded for correctly predicting all 3 matchups.</p>
      <p>4. Payout formula: Min((Total entrants * 100) / Number of winners, 600) - Maximum payout is capped at 600.</p>
    </div>
    
    <form id="calculator-form">
      <div class="games-grid" id="games-container">
        <!-- Games will be dynamically added here -->
      </div>
      
      <button type="button" class="btn calculate-btn" id="calculate-btn">Calculate Results</button>
    </form>
    
    <div id="results-container" style="display: none;">
      <!-- Results will be dynamically added here -->
    </div>
    <button class="btn btn-primary" id="copy-results-btn" style="margin-top: 1rem;">Copy Results</button>
    <!-- Explanation Section -->
  </div>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  class PoolCalculator {
    constructor() {
      this.state = {
        games: [
          { id: 1, team1: { name: 'L1', odds: -110, selectionPercentage: 50, noVigOdds: -100, noVigProbability: 0.5 }, team2: { name: 'R1', odds: -110, selectionPercentage: 50, noVigOdds: -100, noVigProbability: 0.5 }},
          { id: 2, team1: { name: 'L2', odds: -110, selectionPercentage: 50, noVigOdds: -100, noVigProbability: 0.5 }, team2: { name: 'R2', odds: -110, selectionPercentage: 50, noVigOdds: -100, noVigProbability: 0.5 }},
          { id: 3, team1: { name: 'L3', odds: -110, selectionPercentage: 50, noVigOdds: -100, noVigProbability: 0.5 }, team2: { name: 'R3', odds: -110, selectionPercentage: 50, noVigOdds: -100, noVigProbability: 0.5 }}
        ],
        totalEntrants: 9450,
        maxPayout: 600,
        results: {
          combinations: [],
          payouts: {}
        },
        sortBy: 'expectedValue',
        sortDirection: 'desc'
      };

      this.bindEvents();
      this.renderGames();
      this.calculateNoVigOddsForAllGames();
    }

    bindEvents() {
      document.getElementById('calculate-btn').addEventListener('click', () => {
        this.collectFormData();
        this.calculateNoVigOddsForAllGames();
        this.calculateAllCombinations();
      });

      document.getElementById('copy-results-btn').addEventListener('click', () => {
        this.copyResultsToClipboard();
      });

      window.sortTable = this.sortTable.bind(this);
    }

    autofillRightPercents(gameId, changedSide) {
      const leftInput = document.getElementById(`game-${gameId}-team1-selection`);
      const rightInput = document.getElementById(`game-${gameId}-team2-selection`);

      let val = parseFloat(changedSide === 'left' ? leftInput.value : rightInput.value) || 0;
      val = Math.min(100, Math.max(0, val));

      if (changedSide === 'left') {
        rightInput.value = (100 - val).toFixed(0);
      } else {
        leftInput.value = (100 - val).toFixed(0);
      }
    }

    renderGames() {
      const container = document.getElementById('games-container');
      container.innerHTML = '';

      this.state.games.forEach(game => {
        const div = document.createElement('div');
        div.className = 'game-card';
        div.innerHTML = `
          <h3 class="section-title">Game ${game.id}</h3>
          <div class="teams-grid">
            <div class="team-card">
              <div class="form-control"><label class="form-label">${game.team1.name}</label></div>
              <div class="form-control"><label class="form-label">American Odds</label>
                <input type="number" class="form-input" id="game-${game.id}-team1-odds" value="${game.team1.odds}" />
              </div>
              <div class="form-control"><label class="form-label">Selection %</label>
                <input type="number" class="form-input" id="game-${game.id}-team1-selection" value="${game.team1.selectionPercentage}" min="0" max="100"
                oninput="app.autofillRightPercents(${game.id}, 'left')" />
              </div>
              <div class="form-control">
                <label class="form-label">No-Vig Odds: ${game.team1.noVigOdds}</label>
                <div class="text-note">No-Vig Probability: ${(game.team1.noVigProbability * 100).toFixed(2)}%</div>
              </div>
            </div>

            <div class="team-card">
              <div class="form-control"><label class="form-label">${game.team2.name}</label></div>
              <div class="form-control"><label class="form-label">American Odds</label>
                <input type="number" class="form-input" id="game-${game.id}-team2-odds" value="${game.team2.odds}" />
              </div>
              <div class="form-control"><label class="form-label">Selection %</label>
                <input type="number" class="form-input" id="game-${game.id}-team2-selection" value="${game.team2.selectionPercentage}" min="0" max="100"
                oninput="app.autofillRightPercents(${game.id}, 'right')" />
              </div>
              <div class="form-control">
                <label class="form-label">No-Vig Odds: ${game.team2.noVigOdds}</label>
                <div class="text-note">No-Vig Probability: ${(game.team2.noVigProbability * 100).toFixed(2)}%</div>
              </div>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    collectFormData() {
      this.state.games.forEach(game => {
        const t1Odds = document.getElementById(`game-${game.id}-team1-odds`);
        const t1Sel = document.getElementById(`game-${game.id}-team1-selection`);
        const t2Odds = document.getElementById(`game-${game.id}-team2-odds`);
        const t2Sel = document.getElementById(`game-${game.id}-team2-selection`);

        game.team1.odds = parseInt(t1Odds.value) || 0;
        game.team1.selectionPercentage = parseInt(t1Sel.value) || 0;
        game.team2.odds = parseInt(t2Odds.value) || 0;
        game.team2.selectionPercentage = parseInt(t2Sel.value) || 0;
      });
    }

    oddsToImpliedProbability(odds) {
      return odds > 0 ? 100 / (odds + 100) : Math.abs(odds) / (Math.abs(odds) + 100);
    }

    probabilityToAmericanOdds(prob) {
      if (prob <= 0 || prob >= 1) return 0;
      return prob > 0.5 ? -100 * prob / (1 - prob) : 100 * (1 - prob) / prob;
    }

    calculateNoVigOddsForAllGames() {
      this.state.games.forEach(game => {
        const p1 = this.oddsToImpliedProbability(game.team1.odds);
        const p2 = this.oddsToImpliedProbability(game.team2.odds);
        const total = p1 + p2;

        const fairP1 = p1 / total;
        const fairP2 = p2 / total;

        game.team1.noVigProbability = fairP1;
        game.team2.noVigProbability = fairP2;
        game.team1.noVigOdds = Math.round(this.probabilityToAmericanOdds(fairP1));
        game.team2.noVigOdds = Math.round(this.probabilityToAmericanOdds(fairP2));
      });

      this.renderGames();
    }

    generateCombinations() {
      let combos = [
        { teams: [this.state.games[0].team1], gameIds: [1], side: ['team1'] },
        { teams: [this.state.games[0].team2], gameIds: [1], side: ['team2'] }
      ];

      for (let i = 1; i < this.state.games.length; i++) {
        const game = this.state.games[i];
        const newCombos = [];

        combos.forEach(c => {
          newCombos.push({ teams: [...c.teams, game.team1], gameIds: [...c.gameIds, i + 1], side: [...c.side, 'team1'] });
          newCombos.push({ teams: [...c.teams, game.team2], gameIds: [...c.gameIds, i + 1], side: [...c.side, 'team2'] });
        });

        combos = newCombos;
      }

      return combos;
    }

    calculateSelections(combos) {
      return combos.map(combo => {
        let relative = 1;
        combo.teams.forEach((team, idx) => {
          const game = this.state.games[idx];
          const total = game.team1.selectionPercentage + game.team2.selectionPercentage || 100;
          relative *= (team.selectionPercentage / total);
        });

        return {
          ...combo,
          selectionPercentage: relative * 100,
          numberOfSelections: Math.round(this.state.totalEntrants * relative)
        };
      });
    }

    calculateWinProbabilities(combos) {
      return combos.map(combo => {
        const p = combo.teams.reduce((acc, team) => acc * team.noVigProbability, 1);
        return { ...combo, winProbability: p * 100 };
      });
    }

    calculatePayouts(combos) {
      const results = combos.map(combo => {
        const winProb = combo.winProbability / 100;
        const lossProb = 1 - winProb;
        const winners = combo.numberOfSelections || 1;
        const payout = Math.min((this.state.totalEntrants * 100) / winners, this.state.maxPayout);
        const ev = (winProb * payout) - (lossProb * 100);
        return { ...combo, payout, expectedValue: ev };
      });

      return { combinations: results, payouts: {} };
    }

    calculateAllCombinations() {
      const combos = this.generateCombinations();
      const withSelections = this.calculateSelections(combos);
      const withProb = this.calculateWinProbabilities(withSelections);
      const results = this.calculatePayouts(withProb);

      this.state.results = results;
      this.renderResults();
    }

    formatCombination(combo) {
      return combo.teams.map(t => t.name.replace(/\d+/g, '')).join('');
    }

    renderResults() {
      const list = this.state.results.combinations;
      if (!list.length) return document.getElementById('results-container').style.display = 'none';

      const sorted = [...list].sort((a, b) => {
        let va = a[this.state.sortBy], vb = b[this.state.sortBy];
        if (this.state.sortBy === 'picks') {
          va = this.formatCombination(a);
          vb = this.formatCombination(b);
        }
        return this.state.sortDirection === 'asc' ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
      });

      const html = sorted.map(combo => `
        <tr>
          <td>${this.formatCombination(combo)}</td>
          <td>${combo.winProbability.toFixed(2)}%</td>
          <td>${combo.numberOfSelections}</td>
          <td>${Math.round(combo.payout)}</td>
          <td>${Math.round(combo.expectedValue)}</td>
        </tr>
      `).join('');

      const table = `
        <div class="card">
          <h2 class="subheading">All Combinations and Payouts</h2>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Picks</th>
                  <th>Win Probability</th>
                  <th>Selections</th>
                  <th>Payout</th>
                  <th>Expected Value</th>
                </tr>
              </thead>
              <tbody>${html}</tbody>
            </table>
          </div>
        </div>
      `;

      const container = document.getElementById('results-container');
      container.style.display = 'block';
      container.innerHTML = table;
    }

    copyResultsToClipboard() {
      const results = this.state.results.combinations;
      if (!results.length) return;

      const str = results.map(c => {
        const pick = this.formatCombination(c);
        return `${pick} - ${c.winProbability.toFixed(2)}% - (${c.expectedValue.toFixed(2)})`;
      }).join('\n');

      navigator.clipboard.writeText(str).then(() => alert("Results copied!"));
    }

    sortTable(column) {
      this.state.sortBy = column;
      this.state.sortDirection = this.state.sortDirection === 'asc' ? 'desc' : 'asc';
      this.renderResults();
    }
  }


  window.app = new PoolCalculator();
});
</script>
</body>
</html>
